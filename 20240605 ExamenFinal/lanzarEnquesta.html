<!DOCTYPE html>
<html>
    <head>
    <meta charset="UTF-8">
    <Title > Lanzar la Encuesta </Title>
    <style>
    * {font-family: Verdana, Geneva, Tahoma, sans-serif;}
                
    a {
        font-family:Verdana, Geneva, Tahoma, sans-serif;
        text-align: center;
        margin-top: 15px;
        margin-right: 15px;
        padding-left: 10px;
        padding-right: 10px;
        width: 100%;
        height: 45px;
        background-color: #f2796e;
        border: 2px solid #f2796e;
        border-radius: 4px;
        color: #fff;
        font-size: 15px;
        cursor: pointer;
        box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        transition: all 0.1s ease;
    }
    input {
        font-family: Verdana, Geneva, Tahoma, sans-serif; 
        font-size: 14px;
    }
    </style>
    
    </head>
    <body>
    <header>
        <div id="header">
            <span ><img id="logo" src=".\imgCodigo\logo.jpg" class = "rounded-circle"></span>
            <span>Encuesta</span>
        </div>
    </header>
    <form id="miForm" name="miForm" method="get">
        <div>
            <input  id="fpregunta" size = 40  name="fpregunta" placeholder="Introducir pregunta:"></input>
            <span id="fpreguntaError" style="font-size: small; color: #f00;"></span>
        </div>
        <a  id="fEncuesta" name="fEncuesta"  href="javascript:generaEncuesta()">Genera la Encuesta</a>
        <div id="fOpciones" name="fOpciones">
        </div>
        <button type="submit" id ="bPostea" name="bPostea" value="POST" > POST</button>
        </form>
        <dialog id="wmodal" close>
            <form method="dialog">
              <section>
                <p> No se pueden añadir más opciones. Si confirma la operacion se borraran las opciones que ha añadido para esta encuesta.</p>
              </section>
              <menu>
                <button id="cancelBoton"  type="reset">Cancel</button>
                <button id="confirmBoton" type="submit">Confirm</button>
              </menu>
            </form>
        </dialog>
    
    <script>
        
    function creaContadorChar(nombreOpcion){
        // cada opcion tendrá un Listener sobre la longitud del texto, la funcion recibe un string

        fOpcion = "f"+nombreOpcion;
        console.log ("creando listener para " + fOpcion);
        document.getElementById(fOpcion).addEventListener('keyup', ()=>{

                fOpcion25 = fOpcion + "25";
                fOpcionError  = fOpcion + "Error";
                fOpcionContador = fOpcion + "Contador";
                console.log (fOpcion25, fOpcionError, fOpcionContador);

                let texto = document.getElementById(fOpcion).value;
                let contador = texto.length;
                console.log ( "desde UP " + fOpcion + ", desc:" + texto + "cont:" + contador   );
                if (contador > 25) {
                    
                    document.getElementById(fOpcionError).innerHTML = "El campo no puede tener mas de 25 caracteres";
                    document.getElementById(fOpcion).value = window[fOpcion25];
                    document.getElementById(fOpcionContador).innerHTML = "25/25";
                    
                } else {
                    
                    document.getElementById(fOpcionContador).innerHTML = contador +"/25";
                    
                };
                console.log ( "desde UP,"+ fOpcion + ", desc:" + texto + "cont:" + fcontador   );
        }); 

    
        document.getElementById(fOpcion).addEventListener('keydown', ()=>{
            let texto = "";
            let contador = 0;
            if (document.getElementById(fOpcion).value != null ) {
                texto = document.getElementById(fOpcion).value;
                contador  = texto.length;
            };
            console.log ( fOption + "desde Down, desc:" + texto + "cont:" + contador   );

            if (contador == 25) {
                campo = fOpcion +"25";
                window[campo] = texto;
            }
            }); 
    }; // fin de funcion de creacion de listeners


    function añadeOpcion(nombreOpcion) { 

        let fOpciones = document.getElementById("fOpciones");
        
/* Debería generar el codigo equivalente a 
        <div>
        <label> OpcionN:</label>
        <input  id="fOpcionN" name="fOpcionN">
        <span id="fcontadorN" ></span>
        <span id="fdescripcionErrorN""></span> 
        </div>*/

        // insertaré las nuevas opciones antes del boton
        
        let nuevaOpcion = document.createElement("div");
        nuevaOpcion.id="fdiv" + nombreOpcion;
        const referenceElement = document.getElementById("fButtonMas");
        const parentElement = referenceElement.parentNode;
        parentElement.insertBefore(nuevaOpcion, referenceElement);
    

        let nuevaLabel = document.createElement("label");
        nuevaLabel.innerHTML= nombreOpcion;
        nuevaOpcion.appendChild (nuevaLabel);

        let elInput =document.createElement("input");
        elInput.id = "f" + nombreOpcion;
        elInput.name = "f" + nombreOpcion;
        elInput.size = 40;
        nuevaOpcion.appendChild (elInput);

        let elSpan = document.createElement("span");
        elSpan.id = "f" + nombreOpcion +"Contador";
        nuevaOpcion.appendChild (elSpan);

        elSpan = document.createElement("span");
        elSpan.id = "f" + nombreOpcion +"Error";
        nuevaOpcion.appendChild (elSpan);
    };


    
    function añadeButtonMas(){
        let button = document.createElement("button");
        button.innerHTML = "Añadir";
        button.className = "btn btn-primary";
        button.id= "fButtonMas";
        button.name= "fButtonMas";
        button.onclick = ()=>{
            
            const divOpciones = document.querySelector('div[name="fOpciones"]');
            const inputs = divOpciones.querySelectorAll('input');
            if (inputs.length < 4 ) {
                añadeOpcion("Opcion3");
                añadeOpcion("Opcion4");
                creaContadorChar ("Opcion3");
                creaContadorChar ("Opcion4");
            } else {
            alert("No se pueden agregar mas opciones");
            };
        };
        document.getElementById("fOpciones").appendChild(button);
    };
    
    function borraOpciones() { //
            var wmodal = document.getElementById("wmodal");
            console.log ( wmodal);
            wmodal.showModal();
            if (!wmodal.open) { 
                
                console.log("Dialog close");
                wmodal.open();
            } else {
                console.log("Dialog is open");
            };

            // Update button opens a modal dialog


            // lanza escuchas sobre los botones 
            var cancelButton = document.getElementById("cancel");
            var confirmButton = document.getElementById("confirm");

            confirmBoton.addEventListener("click", function () {
                var divOpciones = document.getElementById("fOpciones");
                fOpciones.innerHTML="";
            });
      
            // Form cancel button closes the dialog box
            cancelBoton.addEventListener("click", function () {
                wmodal.close();
             });
            
        };
    
    function generaEncuesta (){

    // detecta si se han introducido opciones
        const divOpciones = document.querySelector('div[name="fOpciones"]');
        const inputs = divOpciones.querySelectorAll('input');
        if (inputs.length < 2 ) { // añade dos opciones y boton
    
    // validacio fpregunta
        let fpregunta = document.getElementById("fpregunta").value.trim()
        if(fpregunta.length==0){ // obligatorio
                fpreguntaError.innerHTML = "Una encuesta sin pregunta parece muy abierta. Indique por favor la pregunta"
                error = true
            }else{
                fpreguntaError.innerHTML = "";
          
// muestra los dos primeros campos de entrada para las opciones 1 y 2
// y un boton para añadir dos opciones más
                añadeButtonMas();
                añadeOpcion ("Opcion1");
                añadeOpcion ("Opcion2");
                creaContadorChar ("Opcion1");
                creaContadorChar ("Opcion2");
            };

        }else{
            borraOpciones();
        };

    };

    function registraBDEncuesta (){
    };

 
    document.addEventListener("DOMContentLoaded", function() {  // primera carga de DOM  
    // variables para control de entrada de texto
        window.fOpcion125 ="";
        window.fOpcion225 ="";
        window.fOpcion325 ="";
        window.fOpcion425 ="";
        

    // Lanza listener para validar el campo pregunta; no usado
        let ePregunta = document.getElementById("fEncuesta"); // la pregunta la valido directamente

        ePregunta.addEventListener('input',() => { 
                ePregunta.setCustomValidity('');
                ePregunta.checkValidity(); 
                console.log(" validación para "+ ePregunta.name+ " "+ ePregunta.validity);
                //                $mensaje = "";
                //                if (miInput.validity.inputMissing)    { let $mensaje = "Campo Obligatorio";};
                //                if (miInput.validity.patternMismatch) { let $mensaje = "Formato no válido";};                
                //                 miInput.setCustomValidity($mensaje);
                //                miInput.reportValidity();

            });
        ePregunta.addEventListener('invalid',() => { // esto es en Submit !!
            console.log(miInput.validity);
                //                let $mensaje = "";
                if (miInput.validity.inputMissing)    { let $mensaje = "Campo Obligatorio";};
                if (miInput.validity.patternMismatch) { let $mensaje = "Formato no válido";};                
                miInput.setCustomValidity($mensaje);
                //               miInput.reportValidity();
            })

           
    // Lanza listener para postear encuesta   
    const emiForm = document.getElementById("miForm");
	console.log (emiForm);

    emiForm.addEventListener('submit', (event)=>{  //validación on submit de la encuesta
            let error= false

            //interrumpe el funcionamiento defecto del evento y para el envio del formulario
            event.preventDefault()

            // validaciones fpregunta
            let vpregunta = document.getElementById("fpregunta").value.trim()
            if(vpregunta.length==0){ // obligatorio
                fpreguntaError.innerHTML = "Una encuesta sin pregunta parece muy abierta. Indique por favor la pregunta"
                error = true
            }else{
                fpreguntaError.innerHTML = ""
                
            };

// Selecciona el div con el atributo name="fOpciones"
        const divOpciones = document.querySelector('div[name="fOpciones"]');

// Selecciona todos los inputs dentro del div seleccionado
        const inputs = divOpciones.querySelectorAll('input');

// Las dos primeras opciones son obligatorias
        inputs.forEach((input, index) => {
            let texto = input.value.trim()
            if((texto.length==0) && ((index == 0)||(index == 1))){
                input.innerHTML = "No puede dejar esta opción vacía";
                error = true;
            
            };
// No hay que verificar que la longitud sea mayor de 25 caracteres porque ya se limita la entrada en el campo  
// Si no hay ningun error enviaría el formulario
            if(!error) {
//              
// Preparo un array para registro en BD
            
                let eEncuesta = array (nombre=>fpregunta,
                                    opcion1=>[txt=>texto1,vot=votOpcion1],
                                    opcion2=>[txt=>texto1,vot=votOpcion1],
                                    opcion3=>[txt=>texto1,vot=votOpcion1],
                                    opcion4=>[txt=>texto1,vot=votOpcion1]);
                                    
//envío el array a php para registro en BD
            registrarEncuesta();
        

            };
                
        });
    });
    });

    </script>
    </body>

</html>